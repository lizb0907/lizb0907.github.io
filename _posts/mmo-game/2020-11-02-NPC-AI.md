---
layout: post
title: 怪物的AI策略
categories: Mmo-Game
description: 怪物AI设计实现基于状态机:休闲AI、战斗AI、脚本AI
keywords: AI，NPC, 状态机，脚本AI
---

怪物AI设计实现基于状态机:休闲AI、战斗AI、脚本AI

**目录**

* TOC
{:toc}

### 表设计

```sh
有几个思想很重要:

1.模板表Npc, 可以简单理解为类型表。

2.实例表Npc_Stub_Editor关联Npc模板表,每个实例有自己特性，例如：
  出生坐标，朝向，基础AI...

3.实例表有配置AI列，模板表也有默认AI列，如果实例表不配置，那么默认模板
  表AI。相反，则以实例表配置AI为主。
```

## Npc创建流程

### 1.初始化数据

#### 1.NpcCreateModule创建Npc对象

```java
private void toCreateObject(Npc npc, DictNpcData dictNpc, int teamLevel,int x,int y,int z,int rotation)
{
    ...
    //NPC初始化
    npc.init();
    npc.afterLoad();
    getScene().addBPObject(npc);

        //初始化怪物
    npc.afterInit();
    ...
}
```
NpcCreateModule创建Npc对象

#### 2.Npc类下初始化属性npc.init();

1.初始化坐标，朝向...

2.初始化NPC数据表相关数据
```sh
private void initDictNpcAttr()
{
    赋值：
    DictNpcStub_editorData实例表
    DictNpcData模板表
    DictNpcBattleData怪物战斗表
}
```

3.initForceAndInteract()初始化阵营和交互类型

4.resetNpcAttr（）设置npc属性（自适应等级！重要）
```sh
/**
* 设置NPC属性
*
* @param teamLevel 自适应等级（大于0 为自适应等级怪）
*/
public void resetNpcAttr(int teamLevel)
{
    1.如果接口传入怪物等级则以接口传入为准，否则以实例表
      配置的怪物等级为准，如果实例表没有配置怪物等级则以
      模板表怪物等级为准。
    2.怪物设置经验：
         a.如果NpcBattle配置了该级别的最大经验值字段maxExp，
           则根据（基础值、最大值、增幅)计算公式，设置经验。
         b.否则直接读NpcBattle配置的基础值。
    3.设置默认移动、姿态...
    4.根据等级属性系数类型和自适应等级获取属性组：
         a.NpcBattle配置了等级属性系数类型rateType
         b.int[] attrs = DictNpcLevelAttrData.getAttr(
           battleData.getRateType(), level)取出属性组
         c.NpcBattle和NpcLevelAttr根据公式计算属性
    5.根据NpcBattle添加固定属性
    6.补魔补蓝
    7.设置怪物伤害最小归属：
      由于抢怪判定，当玩家累计伤害超过该怪物的最大血万分比，则该怪物归属这个玩家
}

```

#### 3.将npc添加到场景里

NpcCreateMoudule下：

getScene().addBPObject(npc);


#### 4.NpcCreateMoudule下npc.afterInit();

1.初始化AI，initAi()

2.设置出生动画，派发无敌buff

3.根据NpcBirth表设置是否使用战斗姿态

## AI模块初始化

### 1.创建NpcAiModule

创建npc时，会在成员变量下直接new一个NpcAiModule
```sh
/**
* @param npc
*/
public NpcAiModule(Npc npc)
{
    super(npc);
    owner = npc;
    battleFsmManager = new NpcAIFsmManager(npc);
    idleAIManager = new NpcIdleAIManager(npc);
    aiSpecialControlParam = AISpeicalcontrolParamFactory.create();
    aiSpecialControlParam.init();
    extraAiLogic = new ExtraAiLogicModule(npc);
    subStrategys = new ArrayList<>(1);
    waittingAddStrategys = new ArrayList<>(1);
    waittingRemoveStrategys = new TIntArrayList(1);
}

创建数据结构战斗状态机，空闲状态机...
```


### 2.初始化AI
NpcCreateMoudule下npc.afterInit()，

```sh
/**
* ai模块初始化
*/
private void initAi()
{
    Npc模板表和Npc_Stub_Editor实例表都会配置基础AI和扩展AI
    ,实例表优先级高。
    1.初始化扩展AI
    2.初始化基础AI
}
```

#### 1.初始化正常AI

```java
/** 初始化正常ai */
private void normalAiInit()
{
    //初始化空闲ai
    initIdleAi();

    if(owner.getNpcType() != NpcTypeEnum.FUNCTION)
    {
        //功能NPC不初始化
        initBattleFsmManager();
    }

    // 初始化拓展AI
    initExtraAi(owner);
}
```

```sh
初始化空闲ai:
private void initIdleAi()
{
    //状态机初始化
    isIdle = true;

    //初始化空闲状态机
    idleAIManager.init(dictNpcCommonAi.getAiDatas());

    //初始化巡逻数据
    int patrolId = owner.getPatrolId();
    if(patrolId > 0)
    {
        patrolPath = DictNpcPatrolPathData.getDictNpcPatrolPathData(patrolId);
    }
}

dictNpcCommonAi.getAiDatas():
    NpcCommonAi表的idleIds字段配置空闲下状态id组，对应NpcIdleAiState表主键
```


#### 2.初始化脚本AI