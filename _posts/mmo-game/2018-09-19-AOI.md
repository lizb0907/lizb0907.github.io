---
layout: post
title: AOI视野管理
categories: Mmo-Game
description: mmo游戏里视野管理
keywords: Transfigure，mmo，game
---

AOI视野管理,采用九宫格

**目录**

* TOC
{:toc}

## 为什么要进行视野管理？

1.如果不进行视野管理，流量上来看，假设平均每秒5个移动包（80字节），1个技能包（160字节），单人每秒多少？500kb。

2.客户端表现来看，客户端受屏幕大小影响，离得远的玩家看不见，没有必要发给客户端。客户端性能所限，玩家多，放各种
技能，当然会看。

3.从性能上考虑，服务端不用遍历全场景对象...也会大大减少性能消耗。


## 视野管理一个经典的实现--九宫格

一般九宫格的一个格子大小大概是100多个左右Grid格子大小,玩家只能看到他周围的九个格子。

![](/images/posts/mmo_game/15.jpg)

注意是每个格子都有个列表，玩家进入时插入，离开时删除。

当玩家发生切换格子的行为，那么势必会导致一些玩家看不到。

![](/images/posts/mmo_game/16.jpg)

服务器进入和离开的人物数据需要发给客户端，对于玩家进入发actor enter消息，对于玩家离开发actor leave,发送玩家的一些数据包，这样人物模型就会在这个客户端重新创建出来。

## 十字链表方式

十字链表就是有两个排序链表，就是XY轴，一个是所有玩家X坐标排序链表，另外一个就是所有玩家Y轴的排序链表，每个玩家同时存在这两个链表中。

针对于大地图，人比较少的时候会采用十字链表方案。

## 两种方案简单对比

![](/images/posts/mmo_game/17.jpg)

九宫格占用内存大，因为每个格子都有一个兴趣列表，大地图格子多，人很少的情况下就会造成大量的浪费。
十字链表占用内存少，有多少人，链表就多长。

## 我们游戏采用九宫格并做了一些优化(增加兴趣列表)

![](/images/posts/mmo_game/14.png)
