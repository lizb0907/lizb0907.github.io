---
layout: post
title: 本地线程分配缓存（TLAB）
categories: Jvm
description: 记录JVM相关
keywords: TLAB,JVM
---

TLAB概念，源码阅读

**目录**

* TOC
{:toc}

## 待补充

## 什么是TLAB？

本地线程分配缓存，jdk1.8默认开启，所以我们项目jvm参数不用特意配置。

java对象分配一般在堆上（不一定在堆上分配，逃逸分析），堆是所有线程共享的，

那么就存在多线程问题，在没有引入TLAB时采用加锁同步机制，对象创建频繁，导致性能低下。

引入TLAB后，

https://dzone.com/articles/thread-local-allocation-buffers

https://alidg.me/blog/2019/6/21/tlab-jvm

## 源码分析

### 1.类的描述

```java
// ThreadLocalAllocBuffer: a descriptor for thread-local storage used by
// the threads for allocation.
//            It is thread-private at any time, but maybe multiplexed over
//            time across multiple threads. The park()/unpark() pair is
//            used to make it available for such multiplexing.
class ThreadLocalAllocBuffer: public CHeapObj<mtThread> {
  friend class VMStructs;
```
ThreadLocalAllocBuffer：用于分配线程本地存储，在任何时候都是线程私有的，

### 2.类的主要成员属性

```java
private:
  HeapWord* _start;                              // address of TLAB
  HeapWord* _top;                                // address after last allocation
  HeapWord* _pf_top;                             // allocation prefetch watermark
  HeapWord* _end;                                // allocation end (excluding alignment_reserve)
  size_t    _desired_size;                       // desired size   (including alignment_reserve)
  size_t    _refill_waste_limit;                 // hold onto tlab if free() is larger than this
  size_t    _allocated_before_last_gc;           // total bytes allocated up until the last gc
```

TLAB内部采用碰撞指针方法，

start头指针，end尾指针，分配指针top, 当top撞上end说明TLAB内存分配满了。

_desired_size 是指TLAB的内存大小

_refill_waste_limit 是允许最大浪费空间


占小狼 
https://www.jianshu.com/p/cd85098cca39

https://programmer.ink/think/thread-local-cache-tlab-for-jvm-source-analysis.html